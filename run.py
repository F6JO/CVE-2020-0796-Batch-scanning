#-*-coding:GBK -*-
# import os
import argparse
import subprocess

import threadpool
import threading


poc = r"CVE-2020-0796-Scanner.exe"
jieguo = []
suo = threading.Lock




def yanzheng(ip):
    output = subprocess.check_output(poc+" "+ip, shell=True).decode()
    if "风险" in output:
        print(ip," 存在漏洞")
        suo.acquire()
        jieguo.append(ip)
        suo.release()
    else:
        print(ip+" No")

def runjieguo():
    print("--------------全部ip验证完毕--------------")
    if len(jieguo) != 0:
        for i in jieguo:
            print(i+" 存在漏洞")
    else:
        print("未探测出存在漏洞的ip")
def run(xc):
    pool = threadpool.ThreadPool(xc)
    xiancheng = threadpool.makeRequests(yanzheng,liebiao)
    for i in xiancheng:
        pool.putRequest(i)
    pool.wait()



if __name__ == '__main__':
    par = argparse.ArgumentParser(description="CVE-2020-0796")
    par.add_argument("-f", dest='wenjian', help='设定ip文本,一行一个')
    par.add_argument("-t", dest='xiancheng', help='设定线程，默认5（非常消耗内存，不建议太高）', default=5, type=int)
    aaa = par.parse_args()
    file = aaa.wenjian
    try:
        wenjian = open(file, 'r')
        liebiao = []
        for i in wenjian.readlines():
            a = i.replace("\n", "")
            liebiao.append(a)
    except Exception as error:
        print("文件打不开或内容不可识别")
        exit()
    print("正在分配线程任务，请稍后")
    run(aaa.xiancheng)
    runjieguo()